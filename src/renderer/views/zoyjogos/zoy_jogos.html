<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ZoyBlocks — Protótipo Game (Phaser 3)</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif}
    #game-container{width:100%;height:100vh;display:block}

    /* Modal/Oráculo */
    #oracleOverlay{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:999;visibility:hidden}
    #oracleCard{background:#fff;padding:20px;border-radius:8px;max-width:520px;width:92%;box-shadow:0 6px 18px rgba(0,0,0,0.25)}
    #oracleCard h2{margin:0 0 8px 0}
    #oracleOptions{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .optBtn{padding:10px;border-radius:6px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer;text-align:left}
    .optBtn:hover{background:#eee}
    #oracleFooter{margin-top:12px;font-size:13px;color:#444}

    /* Top info */
    #infoBar{position:fixed;left:12px;top:12px;z-index:900;background:rgba(255,255,255,0.9);padding:8px 12px;border-radius:6px;box-shadow:0 3px 8px rgba(0,0,0,0.12)}
    #infoBar b{margin-right:6px}

    /* Small helper */
    .hidden{display:none}
  </style>
</head>
<body>
  <div id="game-container"></div>

  <div id="infoBar">
    <b>Modo:</b> Iniciação — <span id="scoreDisplay">Score: 0</span>
  </div>

  <!-- Oráculo (modal) -->
  <div id="oracleOverlay" role="dialog" aria-hidden="true">
    <div id="oracleCard">
      <h2 id="oracleTitle">Oráculo da Robótica</h2>
      <div id="oracleQuestion">Pergunta...</div>
      <div id="oracleOptions"></div>
      <div id="oracleFooter"></div>
    </div>
  </div>

<script>
/* ---------------------------
   Protótipo Phaser 3 — Zoy Game
   - Engine: Phaser 3 (CDN)
   - Visual: formas geométricas
   - Mode inicial: 2 portas (5 pontos cada)
   - Arquivo independente (HTML) — pronto para rodar localmente ou embutir no Electron
   ----------------------------*/

// Base de perguntas (pode ser migrada para arquivos JSON por disciplina)
const QUESTIONS = [
  {
    id: 1,
    question: 'O que faz um resistor em um circuito elétrico?',
    options: ['Armazena carga elétrica', 'Limita a corrente elétrica'],
    answer: 1,
    explanation: 'Resistores limitam a corrente e dissipam energia em forma de calor.'
  },
  {
    id: 2,
    question: 'Qual componente é usado para controlar a velocidade de um motor DC em PWM?',
    options: ['Transistor / MOSFET', 'Condensador eletrolítico'],
    answer: 0,
    explanation: 'Transistores/MOSFETs são usados como chaves para modular a potência do motor (PWM).'
  },
  {
    id: 3,
    question: 'Qual dispositivo serve para medir distância sem contato usando ultrassom?',
    options: ['Sensor IR', 'Sensor ultrassônico HC-SR04'],
    answer: 1,
    explanation: 'O HC-SR04 mede distância por emissão e recepção de ondas ultrassônicas.'
  }
];

// Parâmetros do jogo (modo inicial: 2 portas x 5 pontos)
const MODE = {
  name: 'Iniciação',
  doors: 2,
  pointsPerDoor: 5
};

let gameSceneRef = null; // referencia à cena para modal poder controlar
let currentQuestion = null;
let currentDoorObj = null;
let score = Number(localStorage.getItem('zoy_score') || 0);

document.getElementById('scoreDisplay').innerText = 'Score: ' + score;

document.getElementById('oracleOverlay').addEventListener('click', (e)=>{
  // clicou fora do card fecha? não fecha — evita fechar ao clicar no overlay
  if(e.target === document.getElementById('oracleOverlay')) e.stopPropagation();
});

function openOracleForDoor(scene, doorObj){
  // pick random question
  currentQuestion = QUESTIONS[Math.floor(Math.random()*QUESTIONS.length)];
  currentDoorObj = doorObj;
  gameSceneRef = scene;

  showOracleModal(currentQuestion);
  // pause physics/movimento
  scene.physics.world.pause();
}

function showOracleModal(q){
  const overlay = document.getElementById('oracleOverlay');
  const qEl = document.getElementById('oracleQuestion');
  const opts = document.getElementById('oracleOptions');
  const footer = document.getElementById('oracleFooter');

  qEl.innerText = q.question;
  opts.innerHTML = '';
  q.options.forEach((optText, idx)=>{
    const btn = document.createElement('button');
    btn.className = 'optBtn';
    btn.innerText = optText;
    btn.onclick = ()=>handleAnswer(idx);
    opts.appendChild(btn);
  });

  footer.innerText = 'Escolha uma opção para o Oráculo avaliar.';
  overlay.style.visibility = 'visible';
  overlay.setAttribute('aria-hidden','false');
}

function closeOracleModal(){
  const overlay = document.getElementById('oracleOverlay');
  overlay.style.visibility = 'hidden';
  overlay.setAttribute('aria-hidden','true');
}

function handleAnswer(selectedIndex){
  const footer = document.getElementById('oracleFooter');
  if(selectedIndex === currentQuestion.answer){
    footer.innerText = '✅ Correto! ' + currentQuestion.explanation;
    // abrir porta (visual) e marcar pontos
    if(currentDoorObj && !currentDoorObj.opened){
      currentDoorObj.opened = true;
      // tint verde
      currentDoorObj.fillColor = 0x2ecc71; // not used directly on graphics, we'll set a flag
      // store score
      score += MODE.pointsPerDoor;
      localStorage.setItem('zoy_score', score);
      document.getElementById('scoreDisplay').innerText = 'Score: ' + score;

      // visual: criar uma animação de abertura ou remover colisão
      if(gameSceneRef){
        // remove body so player can cross
        gameSceneRef.time.delayedCall(800, ()=>{
          try{ gameSceneRef.physics.world.remove(currentDoorObj.body); }catch(e){}
        });
        // tint door to green via setFillStyle if it's a Phaser rectangle
        if(currentDoorObj.setFillStyle) currentDoorObj.setFillStyle(0x2ecc71);
      }
    }
  } else {
    footer.innerText = '❌ Errado. Dica: ' + currentQuestion.explanation;
    // não abre porta
  }

  // after short delay, close modal and resume
  setTimeout(()=>{
    closeOracleModal();
    if(gameSceneRef) gameSceneRef.physics.world.resume();
  },1200);
}

/* ------------------ Phaser config and scene ------------------ */
const config = {
  type: Phaser.AUTO,
  parent: 'game-container',
  width: 960,
  height: 640,
  backgroundColor: '#87ceeb',
  physics: {
    default: 'arcade',
    arcade: { debug: false }
  },
  scene: {
    preload: preload,
    create: create,
    update: update
  }
};

const game = new Phaser.Game(config);

function preload(){
  // nenhuma imagem externa; usamos formas geométricas
}

function create(){
  const scene = this;
  // salvar referência global curta para debug
  window._zoy_scene = scene;

  // jogador: retângulo dinâmico com corpo arcade
  player = this.add.rectangle(120, 320, 40, 40, 0x222222);
  this.physics.add.existing(player);
  player.body.setCollideWorldBounds(true);
  player.body.setSize(40,40);

  // portas: cria n portas estáticas do lado direito
  this.doors = [];
  const startY = 200;
  const gap = 160;
  for(let i=0;i<MODE.doors;i++){
    const y = startY + i*gap;
    const door = this.add.rectangle(760, y, 64, 120, 0x8B4513);
    this.physics.add.existing(door, true); // static body
    door.isDoor = true;
    door.opened = false;
    door.doorId = i+1;
    this.doors.push(door);
  }

  // overlap between player and doors
  this.doors.forEach(d=>{
    this.physics.add.overlap(player, d, function(p,dObj){
      if(!dObj.opened){
        openOracleForDoor(scene, dObj);
      }
    }, null, this);
  });

  // borda do mundo
  this.physics.world.setBounds(0,0,960,640);

  // controles
  this.cursors = this.input.keyboard.createCursorKeys();

  // score text (Phaser) - deixamos o infoBar em HTML para persistência mais fácil
  this.add.text(12,610,'Use as setas do teclado para mover o Zoy. Vá até uma porta para o Oráculo.',{fontSize:'14px', color:'#000'});
}

let player;
function update(time,delta){
  const speed = 220;
  if(!this.cursors) return;
  player.body.setVelocity(0);
  if(this.cursors.left.isDown) player.body.setVelocityX(-speed);
  if(this.cursors.right.isDown) player.body.setVelocityX(speed);
  if(this.cursors.up.isDown) player.body.setVelocityY(-speed);
  if(this.cursors.down.isDown) player.body.setVelocityY(speed);
}

// Expose some helpers to console for quick testing
window.zoyHelpers = {
  resetScore: ()=>{ score=0; localStorage.setItem('zoy_score',0); document.getElementById('scoreDisplay').innerText='Score: 0'; location.reload(); },
  setModeToEnem: ()=>{ MODE.name='ENEM'; MODE.doors=10; MODE.pointsPerDoor=1; alert('Modo alterado para ENEM — recarregue a página para ver 10 portas.'); }
};

</script>
</body>
</html>